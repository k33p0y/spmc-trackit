<script>
    let loc = window.location
    let wsStart = loc.protocol == "https:" ? "wss://" : "ws://";
    let url = wsStart + loc.host + '/ws/notifications/';
    const socket = new WebSocket(url)

    socket.onopen = function(event) {
        $('.online-status').addClass('text-success')
        DisplayNotifications();
    }

    socket.onmessage = function(event) {
        //console.log(event)
        //console.log(JSON.parse(event.data))
        DisplayNotifications();
    }

    socket.onclose = function(event) {
        $('.online-status').removeClass('text-success');
    }

    socket.onerror = function(event) {
        console.log(event)
        console.log('something went wrong')
    }

    let DisplayNotifications = function(){
        getUserNotifications().then(data=>{
            let notifications = data
            unread_count = notifications.filter(obj=>obj.unread==true).length
            //console.log(notifications)

            console.log(time)
    
            if (notifications.length){ // if notification is available
                $('.dropdown-notifications-title').html(`Notications (${unread_count}) `) // display unread notification to title
                if (unread_count > 0) $('.new-notifications-count').html(unread_count); // display unread notification to bell
                
                var saveDropdown = $('.dropdown-notifications-div .dropdown-notifications-title').detach();
                $('.dropdown-notifications-div').empty().append(saveDropdown);
                for (i=0; i<notifications.length; i++){
                    user = `${notifications[i].user.first_name} ${notifications[i].user.last_name}`
                    action = `${notifications[i].log.event_type}`
                    time_from_now = moment(notifications[i].log.datetime).fromNow()
                    if (action === 'Create') action = 'created a new request, Ticket no.';
                    else if (action === 'Update') action = 'updated request';
                    if (notifications[i].unread) {
                        bg_color = 'bg-notification'; 
                        display_status = '';
                    } else {
                        bg_color = '';
                        display_status = 'd-none'
                    }
                    
                    ticket_no = `${notifications[i].log.object_id}`.substr(notifications[i].log.object_id.length - 10).toUpperCase()
                    $('.dropdown-notifications-div').append(
                        `<a href="/requests/track" class="dropdown-item dropdown-notification-item d-flex ${bg_color}" data-notification-id="${notifications[i].id}">
                            <div class="notification-content flex-grow-1">
                               <p><b>${user}</b> ${action} <b>${ticket_no}</b></p>
                               <span class="text-muted notification-time">${time_from_now}</span>    
                            </div>
                            <div class="notification-status align-self-center ${display}"><i class="fas fa-circle"></i></div>
                         </a>`
                    )
                }
                $('.dropdown-notifications-div a').click(function(){
                    localStorage.setItem("ticketNumber", $(this).children().first().html());
                    localStorage.setItem("notification-id", $(this).attr('data-notification-id'));
                })
            } else {
                $('.dropdown-notifications-title').html('Notifications (0)')
            }
        });
    }
</script>